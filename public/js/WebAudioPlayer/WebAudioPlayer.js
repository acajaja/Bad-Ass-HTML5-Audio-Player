import*as HttpClient from"./components/HttpClient.js";import{playlists}from"./components/playlists.js";import*as logger from"./components/logger.js";
/**
 * HTML5 JavaScript Audio Player v0.6.
 *
 * Designed to play any supported audio type.
 *
 * @copyright Â© 2013,2017,2022 Clif Jackson
 * @package HTML5 JavaScript Audio Player
 * @version 0.6
 */export const version="0.6";let _DOC,_AUDIO_CODECS_MIMES={mp3:["audio/mpeg","audio/MPA","audio/mpa-robust","audio/mpeg3","audio/x-mpeg-3"],mp4:["audio/aac","audio/aacp","audio/3gpp","audio/3gpp2","audio/mp4","audio/MP4A-LATM","audio/mpeg4-generic"],ogg:["application/ogg","audio/oga","audio/ogg","audio/vorbis","audio/vorbis-config"],webm:["audio/webm"],wav:["audio/vnd.wave","audio/wav","audio/wave","audio/x-wav"]},_WEB_AUDIO=null,_AUTO_PLAY=!1,_CURRENT_TRACK=null,_HTML5_SUPPORT=!1,_PLAYERROOT=null,_PLAYER_CONTROL_NODES=[],_PLAYLIST=null,_TRACK_COUNT=0,_SAVEDVOLUME=0,_PLAYER_PARTS_SELECTORS={ajaxSpinner:".net-stat-box",autoplayBtn:".autoplay-btn",currentTimeDisplay:".current-time",infoButton:".info-button",infoScreen:".info-screen",infoScroll:".info-scroll-box",infoScrollContent:".info-content-box",loadProgress:".loading-bar",muteButton:".mute-button",nextTrackBtn:".next-track-btn",playBtn:".play-btn",playlistBox:".playlist-scroll-box",playlistBtn:".playlist-btn",prevTrackBtn:".prev-track-btn",remainingTime:".remaining-time",seekHandleBox:".seek-handle-box",screenTitle:".screen-title",userScreen:".user-screen",volumeSliderMute:".volume-slider-mute-box",volumeButton:".volume-button",volumeSlider:".volume-slider"},_PLAYER_FUNCS={ajaxSpinner:{},autoplayBtn:{},currentTimeDisplay:null,infoButton:{},infoScreen:{},infoScroll:null,infoScrollContent:null,loadProgress:{},muteButton:{},nextTrackBtn:{},playBtn:{},playlistBox:null,playlistBtn:{},prevTrackBtn:{},remainingTime:null,seekHandleBox:{},screenTitle:null,userScreen:{},volumeButton:{},volumeSliderMute:{},volumeSlider:{}};export const startup=e=>{let t;return window.document.addEventListener("DOMContentLoaded",(n=>{const o=window.document.getElementById(e);t=init(o,window.document)})),t};export const init=(e,t,n=null)=>{_PLAYERROOT=e,_DOC=t,_HTML5_SUPPORT=_checkWebAudioApiSupport();try{if(!_HTML5_SUPPORT)throw new Error("Web Audio is not supported on your device :(");if(_PLAYERROOT.classList.add("paused"),_setAudioObject(n),!_checkMimeSupport())throw new Error("There is no audio codec supported for this device.");return _setUpFunctionality(),_PLAYER_CONTROL_NODES=[_PLAYER_FUNCS.autoplayBtn.node,_PLAYER_FUNCS.playBtn.node,_PLAYER_FUNCS.prevTrackBtn.node,_PLAYER_FUNCS.muteButton.node,_PLAYER_FUNCS.nextTrackBtn.node,_PLAYER_FUNCS.seekHandleBox.node,_PLAYER_FUNCS.volumeSlider.node],_togglePlayerButtons(!0),_PLAYER_FUNCS.volumeSlider.setPosition(1),_PLAYER_FUNCS.seekHandleBox.setPosition(0),_PLAYER_FUNCS.infoButton.disable(!0),_connectPlayerButtons(),_connectAudioEvents(),_renderPlaylistsList(),_WEB_AUDIO}catch(e){logger.error("Failed to initiate the Web Audio Player :(")}};function _getNodeByClass(e){return _DOC.querySelector(`#${_PLAYERROOT.id} ${e}`)}function _ajaxSpinnerToggler(e){e?_PLAYER_FUNCS.ajaxSpinner.node.classList.add("play"):_PLAYER_FUNCS.ajaxSpinner.node.classList.remove("play")}function _autoPlayButtonHandler(e){_AUTO_PLAY?(_AUTO_PLAY=!1,_PLAYERROOT.classList.remove("autoplay")):(_AUTO_PLAY=!0,_PLAYERROOT.classList.add("autoplay"))}function _infoButtonHandler(e){e?(_PLAYER_FUNCS.infoButton.node.classList.remove("has-info"),_PLAYER_FUNCS.infoButton.node.disabled=!0):(_PLAYER_FUNCS.infoButton.node.classList.add("has-info"),_PLAYER_FUNCS.infoButton.node.disabled=!1)}function _infoScreenCloseHandler(e){e&&(_PLAYER_FUNCS.infoScreen.node.classList.add("fast"),_PLAYER_FUNCS.infoScreen.node.classList.remove("fast")),_PLAYER_FUNCS.infoScreen.node.classList.remove("play")}function _infoScreenOpenHandler(){_PLAYER_FUNCS.infoScreen.node.classList.add("play")}function _infoScreenToggler(e){_PLAYER_FUNCS.infoScreen.node.classList.contains("play")?_PLAYER_FUNCS.infoScreen.close():_PLAYER_FUNCS.infoScreen.open()}function _setUpFunctionality(){_PLAYER_FUNCS.ajaxSpinner={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.ajaxSpinner),toggle:_ajaxSpinnerToggler},_PLAYER_FUNCS.autoplayBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.autoplayBtn),handleButton:_autoPlayButtonHandler},_PLAYER_FUNCS.currentTimeDisplay=_getNodeByClass(_PLAYER_PARTS_SELECTORS.currentTimeDisplay),_PLAYER_FUNCS.infoButton={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.infoButton),disable:_infoButtonHandler},_PLAYER_FUNCS.infoScreen={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.infoScreen),close:_infoScreenCloseHandler,open:_infoScreenOpenHandler,toggle:_infoScreenToggler},_PLAYER_FUNCS.infoScroll=_getNodeByClass(_PLAYER_PARTS_SELECTORS.infoScroll),_PLAYER_FUNCS.infoScrollContent=_getNodeByClass(_PLAYER_PARTS_SELECTORS.infoScrollContent),_PLAYER_FUNCS.loadProgress={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.loadProgress),reset:function(){this.setWidth("0")},setFullWidth:function(e){this.setWidth("100%")},setWidth:function(e){_PLAYER_FUNCS.loadProgress.node.style.width=e}},_PLAYER_FUNCS.muteButton={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.muteButton)},_PLAYER_FUNCS.nextTrackBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.nextTrackBtn),handleButton:function(e){_removePlayingClassFromAll(),_loadTrack(_getNextTrack())}},_PLAYER_FUNCS.playBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.playBtn),handleButton:async function(e){_WEB_AUDIO.paused&&null==_CURRENT_TRACK?(_CURRENT_TRACK=0,_loadTrack(_CURRENT_TRACK)):_WEB_AUDIO.paused?await _play(e):_pause(e)}},_PLAYER_FUNCS.playlistBox=_getNodeByClass(_PLAYER_PARTS_SELECTORS.playlistBox),_PLAYER_FUNCS.playlistBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.playlistBtn),handleButton:_loadAllPlaylistsHandler},_PLAYER_FUNCS.prevTrackBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.prevTrackBtn),handleSingleClick:function(e){_WEB_AUDIO.currentTime=0},handleDblClick:function(e){_removePlayingClassFromAll(),_loadTrack(_getPrevTrack())}},_PLAYER_FUNCS.remainingTime=_getNodeByClass(_PLAYER_PARTS_SELECTORS.remainingTime),_PLAYER_FUNCS.seekHandleBox={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.seekHandleBox),handleInput:function(e){_WEB_AUDIO.currentTime=e.target.value},reset:function(){this.node.value=0,this.toggleEnable(!0)},setMax:function(){this.node.setAttribute("max",_WEB_AUDIO.seekable.end(0))},setPosition:function(e){this.node.value=e},toggleEnable:function(e){this.node.disabled=e}},_PLAYER_FUNCS.screenTitle=_getNodeByClass(_PLAYER_PARTS_SELECTORS.screenTitle),_PLAYER_FUNCS.userScreen={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.userScreen),reset:function(){_PLAYER_FUNCS.seekHandleBox.reset(),_PLAYER_FUNCS.infoScreen.close(!0),_PLAYER_FUNCS.loadProgress.reset(),_populateTimeDisplay("00:00","00:00")}},_PLAYER_FUNCS.volumeButton={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.volumeButton),toggleActive:function(){_PLAYER_FUNCS.volumeButton.node.classList.toggle("active")},toggleMute:function(e){_WEB_AUDIO.muted?(_WEB_AUDIO.muted=!1,_PLAYER_FUNCS.volumeSlider.setPosition(_SAVEDVOLUME),_PLAYERROOT.classList.remove("muted")):(_SAVEDVOLUME=_WEB_AUDIO.volume,_WEB_AUDIO.muted=!0,_PLAYER_FUNCS.volumeSlider.setPosition(0),_PLAYERROOT.classList.add("muted"))}},_PLAYER_FUNCS.volumeSliderMute={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.volumeSliderMute),close:function(){_PLAYER_FUNCS.volumeButton.toggleActive(),_PLAYER_FUNCS.volumeSliderMute.node.classList.remove("play")},open:function(){_PLAYER_FUNCS.volumeButton.toggleActive(),_PLAYER_FUNCS.volumeSliderMute.node.classList.add("play")},toggle:function(e){_PLAYER_FUNCS.volumeSliderMute.node.classList.contains("play")?_PLAYER_FUNCS.volumeSliderMute.close():_PLAYER_FUNCS.volumeSliderMute.open()}},_PLAYER_FUNCS.volumeSlider={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS.volumeSlider),handleInput:function(e){_WEB_AUDIO.volume=e.target.value},setPosition:function(e){const t=parseInt(e);_PLAYER_FUNCS.volumeSlider.node.value=t>1?1:t}}}function _loadAllPlaylistsHandler(e){_togglePlayerButtons(!0),_WEB_AUDIO.paused||_pause(),_PLAYER_FUNCS.volumeSliderMute.close(),_PLAYER_FUNCS.userScreen.reset(),_PLAYER_FUNCS.infoButton.disable(!0),_renderPlaylistsList()}function _attachEvents(e,t,n){if("function"!=typeof e.addEventListener)throw new Error("Cannot attach events. Client does not support addEventListener method.");e.addEventListener(t,n,!1)}function _canPlayType(e){return _WEB_AUDIO.canPlayType(e)}function _checkWebAudioApiSupport(){const e=typeof Audio;return"function"==e||"object"==e}function _connectPlayerButtons(){_attachEvents(_PLAYER_FUNCS.autoplayBtn.node,"click",_PLAYER_FUNCS.autoplayBtn.handleButton),_attachEvents(_PLAYER_FUNCS.infoButton.node,"click",_PLAYER_FUNCS.infoScreen.toggle),_attachEvents(_PLAYER_FUNCS.nextTrackBtn.node,"click",_PLAYER_FUNCS.nextTrackBtn.handleButton),_attachEvents(_PLAYER_FUNCS.playBtn.node,"click",_PLAYER_FUNCS.playBtn.handleButton),_attachEvents(_PLAYER_FUNCS.playlistBtn.node,"click",_PLAYER_FUNCS.playlistBtn.handleButton),_attachEvents(_PLAYER_FUNCS.prevTrackBtn.node,"click",_PLAYER_FUNCS.prevTrackBtn.handleSingleClick),_attachEvents(_PLAYER_FUNCS.prevTrackBtn.node,"dblclick",_PLAYER_FUNCS.prevTrackBtn.handleDblClick),_attachEvents(_PLAYER_FUNCS.seekHandleBox.node,"input",_PLAYER_FUNCS.seekHandleBox.handleInput),_attachEvents(_PLAYER_FUNCS.muteButton.node,"click",_PLAYER_FUNCS.volumeButton.toggleMute),_attachEvents(_PLAYER_FUNCS.volumeButton.node,"click",_PLAYER_FUNCS.volumeSliderMute.toggle),_attachEvents(_PLAYER_FUNCS.volumeSlider.node,"input",_PLAYER_FUNCS.volumeSlider.handleInput)}function _checkMimeSupport(){var e="";for(let t in _AUDIO_CODECS_MIMES)for(let n in _AUDIO_CODECS_MIMES[t])if("probably"===(e=_canPlayType(_AUDIO_CODECS_MIMES[t][n]))||"maybe"===e)return t;return!1}function _connectAudioEvents(){_attachEvents(_WEB_AUDIO,"canplay",_play),_attachEvents(_WEB_AUDIO,"ended",_handleEndOfAudioEvent),_attachEvents(_WEB_AUDIO,"loadeddata",_PLAYER_FUNCS.loadProgress.setFullWidth),_attachEvents(_WEB_AUDIO,"pause",_handlePauseEvent),_attachEvents(_WEB_AUDIO,"playing",_handlePlayingEvent),_attachEvents(_WEB_AUDIO,"progress",_handleProgressEvent),_attachEvents(_WEB_AUDIO,"timeupdate",_handleTimeUpdateEvent)}function _convertSecondsToTime(e,t){if(!0===t){var n=Math.floor(e/60,10),o=e-60*n;return(n>9?n:"0"+n)+":"+(o>9?o:"0"+o)}var _=parseInt(e,10),a=Math.floor(_/3600),l=Math.floor((_-3600*a)/60),i=_-3600*a-60*l;return(l<10?"0"+l:l)+":"+(i<10?"0"+i:i)}function _createTextNode(e){return _DOC.createTextNode(e)}function _empty(e){for(;e.firstChild;)e.removeChild(e.firstChild);return e}function _getNextTrack(){var e=_CURRENT_TRACK+1;return e<_TRACK_COUNT?e:0}function _getPrevTrack(){return _CURRENT_TRACK>0?_CURRENT_TRACK-1:_TRACK_COUNT-1}async function _loadPlaylist(e){if("string"!=typeof e||e.length<=0)throw new Error("No playlist has been defined!");return _PLAYER_FUNCS.ajaxSpinner.toggle(!0),_togglePlayerButtons(!0),_PLAYER_FUNCS.playlistBtn.node.classList.remove("active"),await HttpClient.get(e)}async function _playlistButtonHandler(e){const t=e.target.dataset.playlist;e.preventDefault();try{const e=new URL(t);_handlePlaylist(await _loadPlaylist(e.href))}catch(e){console.error("Failed to load playlist")}}function _handlePlaylist(e){_togglePlayerButtons(!1),_PLAYLIST=e,_updateScreenTitle(_PLAYLIST.name),_TRACK_COUNT=_PLAYLIST.tracks.length,_setUpPlaylistDisplay(),_populateTimeDisplay("00:00","00:00");_populateInfoBoxContent(e.info?`<p>${e.info}</p>`:"")}function _renderPlaylistsList(){if(void 0===playlists||null==playlists||playlists.length<=0)throw new Error("No playlists found! See ./components/playlists.js");_PLAYER_FUNCS.playlistBtn.node.classList.add("active"),_updateScreenTitle("Playlists"),_empty(_PLAYER_FUNCS.playlistBox);for(const e of playlists){const t=_DOC.createElement("button"),n=_DOC.createElement("li");t.appendChild(_createTextNode(e.name)),t.dataset.playlist=e.url,t.setAttribute("title",e.name),_attachEvents(t,"click",_playlistButtonHandler),n.appendChild(t),_PLAYER_FUNCS.playlistBox.appendChild(n)}}function _handleEndOfAudioEvent(e){_AUTO_PLAY&&(_removePlayingClassFromAll(),_loadTrack(_getNextTrack()))}function _handlePauseEvent(e){_PLAYERROOT.classList.remove("playing"),_PLAYERROOT.classList.add("paused")}function _handlePlayingEvent(e){var t=_PLAYER_FUNCS.playlistBox.querySelector(`button[data-tracknum="${_CURRENT_TRACK}"]`).parentNode;_PLAYERROOT.classList.remove("paused"),_PLAYERROOT.classList.add("playing"),t.setAttribute("class","current")}function _handleProgressEvent(e){const t=e.target.buffered;for(let e=0;e<t.length;e++){const n=Math.ceil(parseInt(t.end(e)/t.duration*100));_PLAYER_FUNCS.loadProgress.setWidth(n+"%")}}function _handleTimeUpdateEvent(e){const t=e.target.duration,n=e.target.currentTime,o=parseInt(t-n,10);isNaN(o)||(_populateTimeDisplay(_convertSecondsToTime(n),_convertSecondsToTime(o,!0)),_PLAYER_FUNCS.seekHandleBox.setPosition(n))}function _populateInfoBoxContent(e){_empty(_PLAYER_FUNCS.infoScrollContent),_PLAYER_FUNCS.infoScrollContent.innerHTML=e,_PLAYER_FUNCS.infoButton.disable(!1)}function _loadTrack(e){if(_pause(),_PLAYER_FUNCS.seekHandleBox.toggleEnable(!0),_PLAYER_FUNCS.loadProgress.reset(),_CURRENT_TRACK=parseInt(e),_WEB_AUDIO.src=_PLAYLIST.tracks[_CURRENT_TRACK].path,_PLAYLIST.tracks[_CURRENT_TRACK].info.length<=0)_PLAYER_FUNCS.infoButton.disable(!0);else{_populateInfoBoxContent(`<p>${_PLAYLIST.tracks[_CURRENT_TRACK].title}</p>\n\t\t\t${_PLAYLIST.tracks[_CURRENT_TRACK].info}`)}_WEB_AUDIO.load()}function _pause(e){_WEB_AUDIO.pause()}async function _play(e){_PLAYER_FUNCS.seekHandleBox.toggleEnable(!1),_PLAYER_FUNCS.seekHandleBox.setMax();try{await _WEB_AUDIO.play()}catch(e){_PLAYER_FUNCS.seekHandleBox.toggleEnable(!0)}}function _populateTimeDisplay(e,t){_empty(_PLAYER_FUNCS.remainingTime).appendChild(_createTextNode(t)),_empty(_PLAYER_FUNCS.currentTimeDisplay).appendChild(_createTextNode(e))}function _removePlayingClassFromAll(){_PLAYERROOT.classList.remove("playing");const e=_PLAYER_FUNCS.playlistBox.querySelector("current");e&&e.removeAttribute("class")}function _setAudioObject(e=null){_WEB_AUDIO=e??new Audio}function _handleLoadTrack(e){const t=parseInt(e.target.getAttribute("data-tracknum"));e.preventDefault(),_removePlayingClassFromAll(),_loadTrack(t)}function _setUpPlaylistDisplay(){_empty(_PLAYER_FUNCS.playlistBox);for(let e=0;e<_PLAYLIST.tracks.length;e++){const t=_PLAYLIST.tracks[e],n=_DOC.createElement("li"),o=_makeShortTitle(t.title),_=_DOC.createElement("button");_.appendChild(_createTextNode(o)),_.setAttribute("data-tracknum",e),n.appendChild(_),_PLAYER_FUNCS.playlistBox.appendChild(n),_attachEvents(_,"click",_handleLoadTrack)}}function _makeShortTitle(e){if(e.length<=50)return e;const t=e.substr(0,50).split(" ");t.pop();return`${t.join(" ")}...`}function _togglePlayerButtons(e){for(const t of _PLAYER_CONTROL_NODES)t.disabled=e}function _updateScreenTitle(e){_PLAYER_FUNCS.screenTitle.innerHTML=e}
