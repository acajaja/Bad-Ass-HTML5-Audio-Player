import*as HttpClient from"./components/HttpClient.js";import{playlists}from"./components/playlists.js";import*as logger from"./components/logger.js";
/**
 * HTML5 JavaScript Audio Player v0.6.
 *
 * Designed to play any supported audio type.
 *
 * @copyright Â© 2013,2017,2022 Clif Jackson
 * @package HTML5 JavaScript Audio Player
 * @version 0.6
 */export const version="0.6";let _DOC,_AUDIO_CODECS_MIMES={mp3:["audio/mpeg","audio/MPA","audio/mpa-robust","audio/mpeg3","audio/x-mpeg-3"],mp4:["audio/aac","audio/aacp","audio/3gpp","audio/3gpp2","audio/mp4","audio/MP4A-LATM","audio/mpeg4-generic"],ogg:["application/ogg","audio/oga","audio/ogg","audio/vorbis","audio/vorbis-config"],webm:["audio/webm"],wav:["audio/vnd.wave","audio/wav","audio/wave","audio/x-wav"]},_WEB_AUDIO=null,_AUTO_PLAY=!1,_CURRENT_TRACK=null,_HTML5_SUPPORT=!1,_PLAYERROOT=null,_PLAYER_CONTROL_NODES=[],_PLAYLIST=null,_TRACK_COUNT=0,_SAVEDVOLUME=0,_PLAYER_PARTS_SELECTORS_ajaxSpinner=".net-stat-box",_PLAYER_PARTS_SELECTORS_autoplayBtn=".autoplay-btn",_PLAYER_PARTS_SELECTORS_currentTimeDisplay=".current-time",_PLAYER_PARTS_SELECTORS_infoButton=".info-button",_PLAYER_PARTS_SELECTORS_infoScreen=".info-screen",_PLAYER_PARTS_SELECTORS_infoScroll=".info-scroll-box",_PLAYER_PARTS_SELECTORS_infoScrollContent=".info-content-box",_PLAYER_PARTS_SELECTORS_loadProgress=".loading-bar",_PLAYER_PARTS_SELECTORS_muteButton=".mute-button",_PLAYER_PARTS_SELECTORS_nextTrackBtn=".next-track-btn",_PLAYER_PARTS_SELECTORS_playBtn=".play-btn",_PLAYER_PARTS_SELECTORS_playlistBox=".playlist-scroll-box",_PLAYER_PARTS_SELECTORS_playlistBtn=".playlist-btn",_PLAYER_PARTS_SELECTORS_prevTrackBtn=".prev-track-btn",_PLAYER_PARTS_SELECTORS_remainingTime=".remaining-time",_PLAYER_PARTS_SELECTORS_seekHandleBox=".seek-handle-box",_PLAYER_PARTS_SELECTORS_screenTitle=".screen-title",_PLAYER_PARTS_SELECTORS_userScreen=".user-screen",_PLAYER_PARTS_SELECTORS_volumeSliderMute=".volume-slider-mute-box",_PLAYER_PARTS_SELECTORS_volumeButton=".volume-button",_PLAYER_PARTS_SELECTORS_volumeSlider=".volume-slider",_PLAYER_FUNCS={ajaxSpinner:{},autoplayBtn:{},currentTimeDisplay:null,infoButton:{},infoScreen:{},infoScroll:null,infoScrollContent:null,loadProgress:{},muteButton:{},nextTrackBtn:{},playBtn:{},playlistBox:null,playlistBtn:{},prevTrackBtn:{},remainingTime:null,seekHandleBox:{},screenTitle:null,userScreen:{},volumeButton:{},volumeSliderMute:{},volumeSlider:{}};export const startup=id=>{let audio;return window.document.addEventListener("DOMContentLoaded",(e=>{const playerNode=window.document.getElementById(id);audio=init(playerNode,window.document)})),audio};export const init=(playerNode,doc,audio=null)=>{_PLAYERROOT=playerNode,_DOC=doc,_HTML5_SUPPORT=function _checkWebAudioApiSupport(){const type=typeof Audio;return"function"==type||"object"==type}();try{if(!_HTML5_SUPPORT)throw new Error("Web Audio is not supported on your device :(");if(_PLAYERROOT.classList.add("paused"),function _setAudioObject(audio=null){_WEB_AUDIO=audio??new Audio}(audio),!function _checkMimeSupport(){var ans="";for(let x in _AUDIO_CODECS_MIMES)for(let xx in _AUDIO_CODECS_MIMES[x])if("probably"===(ans=_canPlayType(_AUDIO_CODECS_MIMES[x][xx]))||"maybe"===ans)return x;return!1}())throw new Error("There is no audio codec supported for this device.");return function _setUpFunctionality(){_PLAYER_FUNCS.ajaxSpinner={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_ajaxSpinner),toggle:_ajaxSpinnerToggler},_PLAYER_FUNCS.autoplayBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_autoplayBtn),handleButton:_autoPlayButtonHandler},_PLAYER_FUNCS.currentTimeDisplay=_getNodeByClass(_PLAYER_PARTS_SELECTORS_currentTimeDisplay),_PLAYER_FUNCS.infoButton={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_infoButton),disable:_infoButtonHandler},_PLAYER_FUNCS.infoScreen={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_infoScreen),close:_infoScreenCloseHandler,open:_infoScreenOpenHandler,toggle:_infoScreenToggler},_PLAYER_FUNCS.infoScroll=_getNodeByClass(_PLAYER_PARTS_SELECTORS_infoScroll),_PLAYER_FUNCS.infoScrollContent=_getNodeByClass(_PLAYER_PARTS_SELECTORS_infoScrollContent),_PLAYER_FUNCS.loadProgress={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_loadProgress),reset:function(){this.setWidth("0")},setFullWidth:function(e){this.setWidth("100%")},setWidth:function(w){_PLAYER_FUNCS.loadProgress.node.style.width=w}},_PLAYER_FUNCS.muteButton={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_muteButton)},_PLAYER_FUNCS.nextTrackBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_nextTrackBtn),handleButton:function(e){_removePlayingClassFromAll(),_loadTrack(_getNextTrack())}},_PLAYER_FUNCS.playBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_playBtn),handleButton:async function(e){_WEB_AUDIO.paused&&null==_CURRENT_TRACK?(_CURRENT_TRACK=0,_loadTrack(_CURRENT_TRACK)):_WEB_AUDIO.paused?await _play(e):_pause(e)}},_PLAYER_FUNCS.playlistBox=_getNodeByClass(_PLAYER_PARTS_SELECTORS_playlistBox),_PLAYER_FUNCS.playlistBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_playlistBtn),handleButton:_loadAllPlaylistsHandler},_PLAYER_FUNCS.prevTrackBtn={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_prevTrackBtn),handleSingleClick:function(e){_WEB_AUDIO.currentTime=0},handleDblClick:function(e){_removePlayingClassFromAll(),_loadTrack(function _getPrevTrack(){if(_CURRENT_TRACK>0)return _CURRENT_TRACK-1;return _TRACK_COUNT-1}())}},_PLAYER_FUNCS.remainingTime=_getNodeByClass(_PLAYER_PARTS_SELECTORS_remainingTime),_PLAYER_FUNCS.seekHandleBox={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_seekHandleBox),handleInput:function(e){_WEB_AUDIO.currentTime=e.target.value},reset:function(){this.node.value=0,this.toggleEnable(!0)},setMax:function(){this.node.setAttribute("max",_WEB_AUDIO.seekable.end(0))},setPosition:function(val){this.node.value=val},toggleEnable:function(status){this.node.disabled=status}},_PLAYER_FUNCS.screenTitle=_getNodeByClass(_PLAYER_PARTS_SELECTORS_screenTitle),_PLAYER_FUNCS.userScreen={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_userScreen),reset:function(){_PLAYER_FUNCS.seekHandleBox.reset(),_PLAYER_FUNCS.infoScreen.close(!0),_PLAYER_FUNCS.loadProgress.reset(),_populateTimeDisplay("00:00","00:00")}},_PLAYER_FUNCS.volumeButton={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_volumeButton),toggleActive:function(){_PLAYER_FUNCS.volumeButton.node.classList.toggle("active")},toggleMute:function(e){_WEB_AUDIO.muted?(_WEB_AUDIO.muted=!1,_PLAYER_FUNCS.volumeSlider.setPosition(_SAVEDVOLUME),_PLAYERROOT.classList.remove("muted")):(_SAVEDVOLUME=_WEB_AUDIO.volume,_WEB_AUDIO.muted=!0,_PLAYER_FUNCS.volumeSlider.setPosition(0),_PLAYERROOT.classList.add("muted"))}},_PLAYER_FUNCS.volumeSliderMute={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_volumeSliderMute),close:function(){_PLAYER_FUNCS.volumeButton.toggleActive(),_PLAYER_FUNCS.volumeSliderMute.node.classList.remove("play")},open:function(){_PLAYER_FUNCS.volumeButton.toggleActive(),_PLAYER_FUNCS.volumeSliderMute.node.classList.add("play")},toggle:function(e){_PLAYER_FUNCS.volumeSliderMute.node.classList.contains("play")?_PLAYER_FUNCS.volumeSliderMute.close():_PLAYER_FUNCS.volumeSliderMute.open()}},_PLAYER_FUNCS.volumeSlider={node:_getNodeByClass(_PLAYER_PARTS_SELECTORS_volumeSlider),handleInput:function(e){_WEB_AUDIO.volume=e.target.value},setPosition:function(v){const vol=parseInt(v);_PLAYER_FUNCS.volumeSlider.node.value=vol>1?1:vol}}}(),_PLAYER_CONTROL_NODES=[_PLAYER_FUNCS.autoplayBtn.node,_PLAYER_FUNCS.playBtn.node,_PLAYER_FUNCS.prevTrackBtn.node,_PLAYER_FUNCS.muteButton.node,_PLAYER_FUNCS.nextTrackBtn.node,_PLAYER_FUNCS.seekHandleBox.node,_PLAYER_FUNCS.volumeSlider.node],_togglePlayerButtons(!0),_PLAYER_FUNCS.volumeSlider.setPosition(1),_PLAYER_FUNCS.seekHandleBox.setPosition(0),_PLAYER_FUNCS.infoButton.disable(!0),function _connectPlayerButtons(){_attachEvents(_PLAYER_FUNCS.autoplayBtn.node,"click",_PLAYER_FUNCS.autoplayBtn.handleButton),_attachEvents(_PLAYER_FUNCS.infoButton.node,"click",_PLAYER_FUNCS.infoScreen.toggle),_attachEvents(_PLAYER_FUNCS.nextTrackBtn.node,"click",_PLAYER_FUNCS.nextTrackBtn.handleButton),_attachEvents(_PLAYER_FUNCS.playBtn.node,"click",_PLAYER_FUNCS.playBtn.handleButton),_attachEvents(_PLAYER_FUNCS.playlistBtn.node,"click",_PLAYER_FUNCS.playlistBtn.handleButton),_attachEvents(_PLAYER_FUNCS.prevTrackBtn.node,"click",_PLAYER_FUNCS.prevTrackBtn.handleSingleClick),_attachEvents(_PLAYER_FUNCS.prevTrackBtn.node,"dblclick",_PLAYER_FUNCS.prevTrackBtn.handleDblClick),_attachEvents(_PLAYER_FUNCS.seekHandleBox.node,"input",_PLAYER_FUNCS.seekHandleBox.handleInput),_attachEvents(_PLAYER_FUNCS.muteButton.node,"click",_PLAYER_FUNCS.volumeButton.toggleMute),_attachEvents(_PLAYER_FUNCS.volumeButton.node,"click",_PLAYER_FUNCS.volumeSliderMute.toggle),_attachEvents(_PLAYER_FUNCS.volumeSlider.node,"input",_PLAYER_FUNCS.volumeSlider.handleInput)}(),function _connectAudioEvents(){_attachEvents(_WEB_AUDIO,"canplay",_play),_attachEvents(_WEB_AUDIO,"ended",_handleEndOfAudioEvent),_attachEvents(_WEB_AUDIO,"loadeddata",_PLAYER_FUNCS.loadProgress.setFullWidth),_attachEvents(_WEB_AUDIO,"pause",_handlePauseEvent),_attachEvents(_WEB_AUDIO,"playing",_handlePlayingEvent),_attachEvents(_WEB_AUDIO,"progress",_handleProgressEvent),_attachEvents(_WEB_AUDIO,"timeupdate",_handleTimeUpdateEvent)}(),_renderPlaylistsList(),_WEB_AUDIO}catch(err){logger.error("Failed to initiate the Web Audio Player :(")}};function _getNodeByClass(className){return _DOC.querySelector(`#${_PLAYERROOT.id} ${className}`)}function _ajaxSpinnerToggler(state){state?_PLAYER_FUNCS.ajaxSpinner.node.classList.add("play"):_PLAYER_FUNCS.ajaxSpinner.node.classList.remove("play")}function _autoPlayButtonHandler(e){_AUTO_PLAY?(_AUTO_PLAY=!1,_PLAYERROOT.classList.remove("autoplay")):(_AUTO_PLAY=!0,_PLAYERROOT.classList.add("autoplay"))}function _infoButtonHandler(state){state?(_PLAYER_FUNCS.infoButton.node.classList.remove("has-info"),_PLAYER_FUNCS.infoButton.node.disabled=!0):(_PLAYER_FUNCS.infoButton.node.classList.add("has-info"),_PLAYER_FUNCS.infoButton.node.disabled=!1)}function _infoScreenCloseHandler(fast){fast&&(_PLAYER_FUNCS.infoScreen.node.classList.add("fast"),_PLAYER_FUNCS.infoScreen.node.classList.remove("fast")),_PLAYER_FUNCS.infoScreen.node.classList.remove("play")}function _infoScreenOpenHandler(){_PLAYER_FUNCS.infoScreen.node.classList.add("play")}function _infoScreenToggler(e){_PLAYER_FUNCS.infoScreen.node.classList.contains("play")?_PLAYER_FUNCS.infoScreen.close():_PLAYER_FUNCS.infoScreen.open()}function _loadAllPlaylistsHandler(e){_togglePlayerButtons(!0),_WEB_AUDIO.paused||_pause(),_PLAYER_FUNCS.volumeSliderMute.close(),_PLAYER_FUNCS.userScreen.reset(),_PLAYER_FUNCS.infoButton.disable(!0),_renderPlaylistsList()}function _attachEvents(node,event,handler){if("function"!=typeof node.addEventListener)throw new Error("Cannot attach events. Client does not support addEventListener method.");node.addEventListener(event,handler,!1)}function _canPlayType(type){return _WEB_AUDIO.canPlayType(type)}function _convertSecondsToTime(s,rev){if(!0===rev){var mins=Math.floor(s/60,10),secs=s-60*mins;return(mins>9?mins:"0"+mins)+":"+(secs>9?secs:"0"+secs)}var sec_num=parseInt(s,10),hours=Math.floor(sec_num/3600),minutes=Math.floor((sec_num-3600*hours)/60),seconds=sec_num-3600*hours-60*minutes;return(minutes<10?"0"+minutes:minutes)+":"+(seconds<10?"0"+seconds:seconds)}function _createTextNode(str){return _DOC.createTextNode(str)}function _empty(node){for(;node.firstChild;)node.removeChild(node.firstChild);return node}function _getNextTrack(){var hypoNext=_CURRENT_TRACK+1;return hypoNext<_TRACK_COUNT?hypoNext:0}async function _playlistButtonHandler(e){const plu=e.target.dataset.playlist;e.preventDefault();try{const playlistUrl=new URL(plu);!function _handlePlaylist(pl){_togglePlayerButtons(!1),_PLAYLIST=pl,_updateScreenTitle(_PLAYLIST.name),_TRACK_COUNT=_PLAYLIST.tracks.length,function _setUpPlaylistDisplay(){_empty(_PLAYER_FUNCS.playlistBox);for(let x=0;x<_PLAYLIST.tracks.length;x++){const track=_PLAYLIST.tracks[x],li=_DOC.createElement("li"),shortText=_makeShortTitle(track.title),btn=_DOC.createElement("button");btn.appendChild(_createTextNode(shortText)),btn.setAttribute("data-tracknum",x),li.appendChild(btn),_PLAYER_FUNCS.playlistBox.appendChild(li),_attachEvents(btn,"click",_handleLoadTrack)}}(),_populateTimeDisplay("00:00","00:00");_populateInfoBoxContent(pl.info?`<p>${pl.info}</p>`:"")}(await async function _loadPlaylist(pl){if("string"!=typeof pl||pl.length<=0)throw new Error("No playlist has been defined!");return _PLAYER_FUNCS.ajaxSpinner.toggle(!0),_togglePlayerButtons(!0),_PLAYER_FUNCS.playlistBtn.node.classList.remove("active"),await HttpClient.get(pl)}(playlistUrl.href))}catch(ex){}}function _renderPlaylistsList(){if(void 0===playlists||null==playlists||playlists.length<=0)throw new Error("No playlists found! See ./components/playlists.js");_PLAYER_FUNCS.playlistBtn.node.classList.add("active"),_updateScreenTitle("Playlists"),_empty(_PLAYER_FUNCS.playlistBox);for(const playlist of playlists){const button=_DOC.createElement("button"),li=_DOC.createElement("li");button.appendChild(_createTextNode(playlist.name)),button.dataset.playlist=playlist.url,button.setAttribute("title",playlist.name),_attachEvents(button,"click",_playlistButtonHandler),li.appendChild(button),_PLAYER_FUNCS.playlistBox.appendChild(li)}}function _handleEndOfAudioEvent(e){_AUTO_PLAY&&(_removePlayingClassFromAll(),_loadTrack(_getNextTrack()))}function _handlePauseEvent(e){_PLAYERROOT.classList.remove("playing"),_PLAYERROOT.classList.add("paused")}function _handlePlayingEvent(e){var parent=_PLAYER_FUNCS.playlistBox.querySelector(`button[data-tracknum="${_CURRENT_TRACK}"]`).parentNode;_PLAYERROOT.classList.remove("paused"),_PLAYERROOT.classList.add("playing"),parent.setAttribute("class","current")}function _handleProgressEvent(e){const buffd=e.target.buffered;for(let i=0;i<buffd.length;i++){const percentage=Math.ceil(parseInt(buffd.end(i)/buffd.duration*100));_PLAYER_FUNCS.loadProgress.setWidth(percentage+"%")}}function _handleTimeUpdateEvent(e){const dur=e.target.duration,time=e.target.currentTime,totalSecondsRemaining=parseInt(dur-time,10);isNaN(totalSecondsRemaining)||(_populateTimeDisplay(_convertSecondsToTime(time),_convertSecondsToTime(totalSecondsRemaining,!0)),_PLAYER_FUNCS.seekHandleBox.setPosition(time))}function _populateInfoBoxContent(content){_empty(_PLAYER_FUNCS.infoScrollContent),_PLAYER_FUNCS.infoScrollContent.innerHTML=content,_PLAYER_FUNCS.infoButton.disable(!1)}function _loadTrack(ct){if(_pause(),_PLAYER_FUNCS.seekHandleBox.toggleEnable(!0),_PLAYER_FUNCS.loadProgress.reset(),_CURRENT_TRACK=parseInt(ct),_WEB_AUDIO.src=_PLAYLIST.tracks[_CURRENT_TRACK].path,_PLAYLIST.tracks[_CURRENT_TRACK].info.length<=0)_PLAYER_FUNCS.infoButton.disable(!0);else{_populateInfoBoxContent(`<p>${_PLAYLIST.tracks[_CURRENT_TRACK].title}</p>\n\t\t\t${_PLAYLIST.tracks[_CURRENT_TRACK].info}`)}_WEB_AUDIO.load()}function _pause(e){_WEB_AUDIO.pause()}async function _play(e){_PLAYER_FUNCS.seekHandleBox.toggleEnable(!1),_PLAYER_FUNCS.seekHandleBox.setMax();try{await _WEB_AUDIO.play()}catch(ex){_PLAYER_FUNCS.seekHandleBox.toggleEnable(!0)}}function _populateTimeDisplay(current,remain){_empty(_PLAYER_FUNCS.remainingTime).appendChild(_createTextNode(remain)),_empty(_PLAYER_FUNCS.currentTimeDisplay).appendChild(_createTextNode(current))}function _removePlayingClassFromAll(){_PLAYERROOT.classList.remove("playing");const current=_PLAYER_FUNCS.playlistBox.querySelector("current");current&&current.removeAttribute("class")}function _handleLoadTrack(e){const trackNum=parseInt(e.target.getAttribute("data-tracknum"));e.preventDefault(),_removePlayingClassFromAll(),_loadTrack(trackNum)}function _makeShortTitle(titleStr){if(titleStr.length<=50)return titleStr;const split=titleStr.substr(0,50).split(" ");split.pop();return`${split.join(" ")}...`}function _togglePlayerButtons(state){for(const node of _PLAYER_CONTROL_NODES)node.disabled=state}function _updateScreenTitle(str){_PLAYER_FUNCS.screenTitle.innerHTML=str}